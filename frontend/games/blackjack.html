<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Blackjack</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: radial-gradient(circle at center, #006633 0%, #00331a 100%);
      color: white;
      text-align: center;
      margin: 0;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    h1 {
      font-size: 2.5em;
      margin-top: 10px;
    }

    #pointsDisplay {
      position: absolute;
      top: 20px;
      right: 25px;
      font-size: 1.3rem;
      color: #ffd700;
      font-weight: bold;
    }

    #backBtn {
      position: absolute;
      top: 20px;
      left: 25px;
      background-color: #444;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }

    #backBtn:hover {
      background-color: #1abc9c;
    }

    .section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }

    .score {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .hand {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 10px;
      padding: 10px;
      border-radius: 10px;
      min-height: 160px;
    }

    .card {
      width: 100px;
      height: 145px;
      background-size: cover;
      border-radius: 8px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.5);
      transition: transform 0.2s;
    }

    .back {
      background-image: url("https://deckofcardsapi.com/static/img/back.png");
    }

    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background-color: #228B22;
      color: white;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #32CD32;
    }

    #result {
      font-size: 22px;
      font-weight: bold;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>‚ô† Blackjack ‚ô£</h1>
  <button id="backBtn" onclick="window.location.href='../starting_page.html'">‚¨ÖÔ∏è Zur√ºck</button>
  <div id="pointsDisplay">Punkte: ‚Äì</div>

  <div class="section">
    <div class="score" id="dealerScore"></div>
    <div id="dealer" class="hand"></div>
  </div>

  <div class="section">
    <div class="score" id="playerScore"></div>
    <div id="player" class="hand"></div>
  </div>

  <div>
    <button id="startBtn">üé∞ Spiel starten</button>
    <button id="hitBtn" disabled>Hit</button>
    <button id="standBtn" disabled>Stand</button>
  </div>

<!--Button f√ºr einsatz nur design-->
<div id="betContainer" style="margin-top: 20px;">
  <label for="betInput">üí∞ Einsatz:</label>
  <input id="betInput" type="number" min="1" value="10" style="width:80px; padding:5px; border-radius:5px; border:none; text-align:center;">
</div>


  <p id="result"></p>

<script>
  const API_BASE = "http://localhost:8000/api/casino";
  const pointsDisplay = document.getElementById("pointsDisplay");

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }

  // Punkte laden
  async function loadPoints() {
    const res = await fetch(`${API_BASE}/session/`, { credentials: "include" });
    const data = await res.json();
    if (data.authenticated) {
      pointsDisplay.textContent = `üí∞ ${data.user.points} Punkte`;
      // Punkte-Limit f√ºr Einsatzfeld
      const betInput = document.getElementById("betInput");
      if (betInput) betInput.max = data.user.points;
    }
  }
  loadPoints();

  // Echtzeit-Update per WebSocket
  const ws = new WebSocket("ws://localhost:8000/ws/points/");
  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === "points_update") {
      pointsDisplay.textContent = `üí∞ ${data.points} Punkte`;
      const betInput = document.getElementById("betInput");
      if (betInput) betInput.max = data.points;
    }
  };

  let player = [];
  let dealer = [];
  let bet = 0;
  let gameRunning = false;

  const dealerScore = document.getElementById("dealerScore");
  const playerScore = document.getElementById("playerScore");
  const resultText = document.getElementById("result");

  function cardImage(card) {
    if (card.rank === "?" || card.suit === "back") {
      return "https://deckofcardsapi.com/static/img/back.png";
    }
    return `https://deckofcardsapi.com/static/img/${card.rank}${card.suit}.png`;
  }

  function renderHand(elementId, hand) {
    const div = document.getElementById(elementId);
    div.innerHTML = "";
    hand.forEach(card => {
      const img = document.createElement("div");
      img.classList.add("card");
      img.style.backgroundImage = `url(${cardImage(card)})`;
      div.appendChild(img);
    });
  }

  function getValue(hand) {
    let total = 0, aces = 0;
    for (let c of hand) {
      if (["J","Q","K"].includes(c.rank)) total += 10;
      else if (c.rank === "A") { total += 11; aces++; }
      else if (c.rank !== "?") total += parseInt(c.rank);
    }
    while (total > 21 && aces--) total -= 10;
    return total;
  }

  function updateDisplay(showDealer = false) {
    dealerScore.textContent = showDealer ? `Dealer: ${getValue(dealer)}` : "Dealer: ???";
    playerScore.textContent = `Spieler: ${getValue(player)}`;
    renderHand("dealer", dealer);
    renderHand("player", player);
  }

  // üé∞ Spiel starten
  document.getElementById("startBtn").onclick = async () => {
    const betInput = document.getElementById("betInput");
    const inputBet = parseInt(betInput.value);

    if (!inputBet || inputBet <= 0) {
      alert("Bitte einen g√ºltigen Einsatz eingeben!");
      return;
    }

    // Falls kein laufendes Spiel -> neuen Einsatz √ºbernehmen
    if (!gameRunning || inputBet !== bet) {
      bet = inputBet;
    }

    const res = await fetch(`${API_BASE}/play-blackjack/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      credentials: "include",
      body: JSON.stringify({ bet })
    });

    const data = await res.json();
    if (!res.ok) return alert(data.error || "Fehler beim Spielstart");

    player = data.player;
    dealer = data.dealer;
    resultText.textContent = "Das Spiel l√§uft...";

    updateDisplay(false);
    document.getElementById("hitBtn").disabled = false;
    document.getElementById("standBtn").disabled = false;
    document.getElementById("startBtn").disabled = true;
    betInput.disabled = true; // Einsatz sperren w√§hrend der Runde
    gameRunning = true;
  };

  // üÉè Hit ‚Äì Karte ziehen
  document.getElementById("hitBtn").onclick = async () => {
    const res = await fetch(`${API_BASE}/blackjack-hit/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      credentials: "include"
    });

    const data = await res.json();
    if (!res.ok) return alert(data.error || "Fehler bei Hit");

    player = data.player;
    dealer = data.dealer;
    updateDisplay(false);

    if (data.result === "lose") {
      resultText.textContent = `üí• √úberkauft! -${bet} Punkte.`;
      endRound();
    }
  };

  // üß† Stand ‚Äì Dealer spielt
  document.getElementById("standBtn").onclick = async () => {
    const res = await fetch(`${API_BASE}/blackjack-stand/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      credentials: "include"
    });

    const data = await res.json();
    if (!res.ok) return alert(data.error || "Fehler beim Stand");

    player = data.player;
    dealer = data.dealer;
    updateDisplay(true);

    let text = "";
    if (data.result === "win") text = `üéâ Du gewinnst ${data.payout} Punkte!`;
    else if (data.result === "lose") text = `üòî Dealer gewinnt. -${bet} Punkte.`;
    else text = "ü§ù Unentschieden. Einsatz zur√ºck.";
    resultText.textContent = text;

    endRound();
  };

  function endRound() {
    document.getElementById("hitBtn").disabled = true;
    document.getElementById("standBtn").disabled = true;
    document.getElementById("startBtn").disabled = false;
    document.getElementById("betInput").disabled = false; // Einsatz wieder freigeben
    loadPoints();
    gameRunning = false;
  }
</script>
</body>
</html>
